# ゲームロジックの実装について

このドキュメントでは、ゲームロジックの実装について説明します。  
ここで指すゲームロジックとは、人狼ゲームのルールならびにその遂行に関わる処理全般を指します。  

## 人狼ゲームのルール

### 役職、陣営、種族

人狼ゲームには、以下の役職が存在します。

| 役職   | 英語名    | 陣営     | 種族 |
| ------ | --------- | -------- | ---- |
| 人狼   | WEREWOLF  | 人狼陣営 | 人狼 |
| 狂人   | POSSESSED | 人狼陣営 | 人間 |
| 占い師 | SEER      | 市民陣営 | 人間 |
| 騎士   | BODYGUARD | 市民陣営 | 人間 |
| 村人   | VILLAGER  | 市民陣営 | 人間 |
| 霊媒師 | MEDIUM    | 市民陣営 | 人間 |

市民陣営の英語名は `VILLAGER` 、人狼陣営の英語名は`WEREWOLF`です。  
種族の人間の英語名は `HUMAN` 、人狼の英語名は `WEREWOLF` です。

詳細な実装については、[role.go](../model/role.go)を参照してください。

### 人数

#### 5人ゲーム

| 役職   | 人数 |
| ------ | ---- |
| 人狼   | 1    |
| 狂人   | 1    |
| 占い師 | 1    |
| 騎士   | 0    |
| 村人   | 2    |
| 霊媒師 | 0    |

### フェーズの流れ

#### 囁きフェーズ

人狼のエージェント数が2未満であるため、スキップされます。  
人狼のエージェント数が2以上である場合は、以下の処理をします。

生存している人狼エージェントをランダムに並び替えた順列を作成します。  
`game.whisper.max_count.per_day` の回数まで以下の処理を繰り返します。  
&emsp;&emsp;順列の先頭から順にエージェントに対して、以下の処理を繰り返します。  
&emsp;&emsp;&emsp;&emsp;エージェントの `game.whisper.max_count.per_agent` の残り回数が0の場合は、スキップします。  
&emsp;&emsp;&emsp;&emsp;エージェントに `WHISPER` リクエストを送信します。  
&emsp;&emsp;&emsp;&emsp;エージェントからの `WHISPER` リクエストを受信します。  
&emsp;&emsp;&emsp;&emsp;エラーが発生した場合は、スキップ発言に置換します。 (スキップカウントの増加は行いません)  
&emsp;&emsp;&emsp;&emsp;スキップカウントが `game.skip.max_count` を超えた場合は、オーバー発言に置換します。  
&emsp;&emsp;&emsp;&emsp;発言がオーバーもしくはスキップではない場合は、スキップカウントをリセットします。  
&emsp;&emsp;&emsp;&emsp;発言がオーバーである場合は、残り回数を0に設定します。  
&emsp;&emsp;全エージェントの発言がオーバーである場合は、トークフェーズを終了します。

#### トークフェーズ

生存しているエージェント数が2未満であるため、スキップされます。
生存しているエージェント数が2以上である場合は、以下の処理をします。

生存しているエージェントをランダムに並び替えた順列を作成します。  
`game.talk.max_count.per_day` の回数まで以下の処理を繰り返します。  
&emsp;&emsp;順列の先頭から順にエージェントに対して、以下の処理を繰り返します。  
&emsp;&emsp;&emsp;&emsp;エージェントの `game.talk.max_count.per_agent` の残り回数が0の場合は、スキップします。  
&emsp;&emsp;&emsp;&emsp;エージェントに `TALK` リクエストを送信します。  
&emsp;&emsp;&emsp;&emsp;エージェントからの `TALK` リクエストを受信します。  
&emsp;&emsp;&emsp;&emsp;エラーが発生した場合は、スキップ発言に置換します。 (スキップカウントの増加は行いません)  
&emsp;&emsp;&emsp;&emsp;スキップカウントが `game.skip.max_count` を超えた場合は、オーバー発言に置換します。  
&emsp;&emsp;&emsp;&emsp;発言がオーバーもしくはスキップではない場合は、スキップカウントをリセットします。  
&emsp;&emsp;&emsp;&emsp;発言がオーバーである場合は、残り回数を0に設定します。  
&emsp;&emsp;全エージェントの発言がオーバーである場合は、トークフェーズを終了します。

#### 追放フェーズ

生存しているエージェントに対して、`VOTE` リクエストを送信します。  
エージェントからのレスポンスを受信します。  
受信したターゲットとなるエージェントが生存している有効票をカウントし、最多票を得たエージェントが1人の場合は、そのエージェントを追放します。  
最多票を得たエージェントが複数の場合は `game.vote.max_count` の回数まで再度投票を行います。  
再度投票を行っても最多票を得たエージェントが複数の場合は、最後の投票で最多票を得たエージェントからランダムに1人を追放します。  
有効票がない場合はエージェントを追放しません。  
エージェントが追放された場合は、その結果を追放結果、霊能結果に設定します。

#### 占いフェーズ

生存している占い師に対して、`DIVINE` リクエストを送信します。  
エージェントからのレスポンスを受信します。  
受信したターゲットとなるエージェントの種族を占い結果に設定します。  
ターゲットが生存していない場合は設定しません。

#### 護衛フェーズ

生存している騎士に対して、`GUARD` リクエストを送信します。  
エージェントからのレスポンスを受信します。  
受信したターゲットとなるエージェントを護衛対象に設定します。  
ターゲットが生存していない場合は設定しません。

#### 襲撃フェーズ

生存している人狼に対して、`ATTACK` リクエストを送信します。  
エージェントからのレスポンスを受信します。  
受信したターゲットとなるエージェントが生存しているかつ、エージェントが人狼陣営ではない有効票をカウントし、最多票を得たエージェントが1人の場合は、そのエージェントを襲撃します。  
最多票を得たエージェントが複数の場合は `game.attack.max_count` の回数まで再度投票を行います。  
再度投票を行っても最多票を得たエージェントが複数の場合かつ `game.attack.allow_no_target` が `false` の場合は、最後の投票で最多票を得たエージェントからランダムに1人を襲撃します。  
襲撃対象のエージェントが護衛されていない場合のみ、襲撃対象のエージェントを襲撃します。  
この時点において騎士が生存している場合にのみ、護衛が有効です。  
エージェントが襲撃された場合は、その結果を襲撃結果に設定します。

### ゲームの流れ

5人ゲームの場合を例に説明します。  
ゲームの設定は以下の通りです。

```yaml
game:
  agent_count: 5 # 1ゲームあたりのエージェント数
  vote_visibility: false # 投票の結果を公開するか
  talk_on_first_day: true # 1日目の発言を許可するか
  max_continue_error_ratio: 0.2 # ゲームを継続するエラーエージェントの最大割合
  talk:
    max_count:
      per_agent: 3 # 1日あたりの1エージェントの最大発言回数
      per_day: 15 # 1日あたりの全体の発言回数
  whisper:
    max_count:
      per_agent: 3 # 1日あたりの1エージェントの最大囁き回数
      per_day: 15 # 1日あたりの全体の囁き回数
  skip:
    max_count: 3 # 1日あたりの1エージェントの最大スキップ回数
  vote:
    max_count: 1 # 1位タイの場合の最大再投票回数
  attack:
    max_count: 1 # 1位タイの場合の最大襲撃再投票回数
    allow_no_target: true # 襲撃なしの日を許可するか
  timeout:
    action: 60s # エージェントのアクションのタイムアウト時間
    response: 90s # エージェントの生存確認のタイムアウト時間
```

#### ゲームの開始 

全エージェントに対して、 `INITIALIZE` リクエストを送信します。

#### 0日目の昼の開始

全エージェントに対して `DAILY_INITIALIZE` リクエストを。  
`game.talk_on_first_day` が `true` の場合は、囁きフェーズが開始します。  
トークフェーズが開始します。

#### 0日目の夜の開始

全エージェントに対して `DAILY_FINISH` リクエストを送信します。  
`game.talk_on_first_day` が `true` の場合は、囁きフェーズが開始します。  
占いフェーズが開始します。

#### 1日目の昼の開始

全エージェントに対して `DAILY_INITIALIZE` リクエストを送信します。  
トークフェーズが開始します。

#### 1日目の夜の開始

全エージェントに対して `DAILY_FINISH` リクエストを送信します。  
追放フェーズを開始します。  
占いフェーズを開始します。  
囁きフェーズを開始します。  
護衛フェーズを開始します。  
襲撃フェーズを開始します。

#### 2日目以降

1日目の昼の開始から繰り返します。  
夜の終了時点で、生存しているエージェントの陣営のどちらかが0人の場合は、ゲームを終了します。  
また、役職が人狼のエージェントが0人の場合は、ゲームを終了します。  
また、`エージェント数*game.max_continue_error_ratio` 以上のエージェントがエラー状態になった場合もゲームを終了します。  

#### ゲームの終了

全エージェントに対して、`FINISH` リクエストを送信します。